---
title: NodeJsæ·±å…¥æµ…å‡ºä¹‹æ—…ï¼šå¼‚æ­¥I/O ï¼ˆä¸Šï¼‰ğŸ‹
date: 8/18/2021, 9:28:37 PM
tags: 
    - Node.js 
    - å‰ç«¯
categories: 
    - nodeå­¦ä¹ 
---

<!--more-->

---

---
**è¿™æ˜¯æˆ‘å‚ä¸8æœˆæ›´æ–‡æŒ‘æˆ˜çš„ç¬¬18å¤©ï¼Œæ´»åŠ¨è¯¦æƒ…æŸ¥çœ‹ï¼š[8æœˆæ›´æ–‡æŒ‘æˆ˜](https://juejin.cn/post/6987962113788493831 "https://juejin.cn/post/6987962113788493831")**

# å¼‚æ­¥I/O

åœ¨å‰ç«¯ï¼Œæœ€ç»å…¸çš„å¼‚æ­¥å°±æ˜¯**Ajax**

æ–‡ç« ä»‹ç»ï¼š[ã€Šé«˜æ€§èƒ½ JavaScriptã®å…­ -- è€ç”Ÿå¸¸è°ˆ Ajaxã€‹](https://blog.csdn.net/qq_36171287/article/details/117201363)


Nodeæ˜¯é¦–ä¸ªå¤§è§„æ¨¡å°†å¼‚æ­¥I/Oåº”ç”¨åœ¨åº”ç”¨å±‚ä¸Šçš„å¹³å°ï¼ŒåŠ›æ±‚åœ¨å•çº¿ç¨‹ä¸Šå°†èµ„æºåˆ†é…çš„æ›´é«˜æ•ˆ

ä¸ºäº†å¼¥è¡¥å•çº¿ç¨‹æ— æ³•åˆ©ç”¨å¤šæ ¸CPUçš„ç¼ºç‚¹ï¼ŒNodeæä¾›äº†ç±»ä¼¼å‰ç«¯æµè§ˆå™¨ä¸­Web Workersçš„å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å¯ä»¥é€šè¿‡å·¥ä½œè¿›ç¨‹é«˜æ•ˆçš„åˆ©ç”¨CPUå’ŒI/O


![å¼‚æ­¥IOè°ƒç”¨.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f00747e021ca4e3c97257686bead7d46~tplv-k3u1fbpfcp-watermark.image)



Nodeå¼‚æ­¥I/OåŸºæœ¬è¦ç´ ï¼š
* äº‹ä»¶å¾ªç¯ï¼š 
* è§‚å¯Ÿè€…ï¼š
* è¯·æ±‚å¯¹è±¡
* I/Oçº¿ç¨‹æ± 

äº‹ä»¶å¾ªç¯æ˜¯ä¸€ä¸ªå…¸å‹çš„ç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å‹ã€‚ å¼‚æ­¥I/Oã€ç½‘ç»œè¯·æ±‚æ˜¯äº‹ä»¶ç”Ÿäº§è€…ï¼Œä¸ºNodeæä¾›ä¸åŒç±»å‹çš„äº‹ä»¶ï¼Œäº‹ä»¶è¢«ä¼ é€’åˆ°å¯¹åº”çš„è§‚å¯Ÿè€…é‚£é‡Œï¼Œäº‹ä»¶å¾ªç¯ä»è§‚å¯Ÿè€…é‚£å–å‡ºäº‹ä»¶å¹¶å¤„ç†

å®˜æ–¹ä»‹ç»ï¼šhttp://nodejs.cn/learn/the-nodejs-event-loop

å¼‚æ­¥æµç¨‹


![å¼‚æ­¥IOæµç¨‹.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/74f82e6d48c24912b5f395504d9466e2~tplv-k3u1fbpfcp-watermark.image)


nodeä¸­ä½¿ç”¨importï¼š https://blog.csdn.net/goutinga/article/details/108074649


æµ‹è¯•ä»£ç ï¼š
``` javascript
import { nextTick } from 'process';

module.exports = function (app) { 
    nextTick(() => console.log(1));  // ä¼˜å…ˆçº§ç¬¬äºŒ
    setImmediate(() => console.log(2));  // ä¼˜å…ˆçº§æœ€ä½
    Promise.resolve().then(() => console.log(3)); // ä¼˜å…ˆçº§ç¬¬ä¸‰
    queueMicrotask(() => console.log(4));  // ä¼˜å…ˆçº§ç¬¬å››
    setTimeout(() => console.log(6), 0);  // ä¼˜å…ˆçº§ç¬¬äº”
    console.log(5)  // ä¼˜å…ˆçº§æœ€é«˜
}
```

**è¾“å‡ºçš„é¡ºåºï¼š5  1  3  4  6  2**

è¿™é‡Œå¯ä»¥å‘ç°ï¼Œ`nextTick`ä¸­å›è°ƒå‡½æ•°çš„æ‰§è¡Œä¼˜å…ˆçº§æœ€é«˜ï¼Œè€Œ`setImmediate`çš„æ‰§è¡Œä¼˜å…ˆçº§æœ€ä½ã€‚

> åŸå› åœ¨äºäº‹ä»¶å¾ªç¯å¯¹è§‚å¯Ÿè€…çš„æ£€æŸ¥æ˜¯æœ‰å…ˆåé¡ºåºçš„ï¼Œ `nextTick`å±äºidleè§‚å¯Ÿè€…ï¼Œ `setImmediate`å±äºcheckè§‚å¯Ÿè€…ã€‚ idleè§‚å¯Ÿè€…å…ˆäºI/Oè§‚å¯Ÿè€…ï¼Œ I/Oè§‚å¯Ÿè€…å…ˆäºcheckè§‚å¯Ÿè€… 


<br/>

## å¼‚æ­¥ç¼–ç¨‹ ğŸŸ

### é«˜é˜¶å‡½æ•°

åœ¨é€šå¸¸çš„è¯­è¨€ä¸­ï¼Œå‡½æ•°çš„å‚æ•°åªæ¥å—åŸºæœ¬çš„æ•°æ®ç±»å‹æˆ–æ˜¯å¯¹è±¡å¼•ç”¨ï¼Œè¿”å›å€¼ä¹Ÿåªæ˜¯åŸºæœ¬æ•°æ®ç±»å‹å’Œå¯¹è±¡å¼•ç”¨ã€‚

åŸºæœ¬å‡½æ•°ï¼š
``` javascript
function foo(x) { 
    return x;
}
```

é«˜é˜¶å‡½æ•°æ˜¯å¯ä»¥æŠŠå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œæˆ–æ˜¯å°†å‡½æ•°ä½œä¸ºè¿”å›å€¼

é«˜é˜¶å‡½æ•°ï¼š
``` javascript
function foo(x) {
    return function () {
        return x;
    };
}
```

### åå‡½æ•°

åå‡½æ•°ç”¨æ³•æŒ‡åˆ›å»ºä¸€ä¸ªè°ƒç”¨å¦å¤–ä¸€ä¸ªéƒ¨åˆ†ï¼ˆå‚æ•°æˆ–å˜é‡å·²ç»é¢„ç½®çš„å‡½æ•°ï¼‰çš„å‡½æ•°ç”¨æ³•

ä¸¾ä¸ªç²’å­, å®šä¹‰åˆ¤æ–­ç±»åˆ«çš„æ–¹æ³•ï¼š
``` javascript
var toString = Object.prototype.toString;

var isString = function(obj) {
    return toString.call(obj) == '[object String]';
}
var isFunction = function(obj) {
    return toString.call(obj) == '[object Function]';
}
```

å¦‚æœéœ€è¦é‡å¤å®šä¹‰ä¸€äº›ç›¸ä¼¼çš„å‡½æ•°ï¼Œè¿™æ ·ä»£ç å°±ä¼šå†—ä½™ã€‚ ä¸ºäº†è§£å†³é‡å¤å®šä¹‰çš„é—®é¢˜ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°å‡½æ•°ï¼š
``` javascript
var isType = function(type) {
    return function(obj) {
        return toString.call(obj) == '[object ' + type + ']';
    }
}

var isString = isType('String');
var isFunction = isType('Function');
```

è¿™ç§`é€šè¿‡æŒ‡å®šéƒ¨åˆ†å‚æ•°æ¥äº§ç”Ÿä¸€ä¸ªæ–°çš„å®šåˆ¶å‡½æ•°çš„å½¢å¼å°±æ˜¯`**åå‡½æ•°**

<br><br>

***
### å¼‚å¸¸å¤„ç†

åœ¨æ™®é€šå¼‚å¸¸å¤„ç†å½“ä¸­ï¼Œé€šå¸¸ä½¿ç”¨`try/catch/final`è¯­å¥å—è¿›è¡Œå¼‚å¸¸æ•è·ã€‚

ä½†æ˜¯è¿™åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­å¹¶ä¸ä¸€å®šä½¿ç”¨ã€‚ å¼‚æ­¥I/Oå®ç°ä¸»è¦åŒ…æ¶µåœ¨ä¸¤ä¸ªé˜¶æ®µï¼š1ã€æäº¤è¯·æ±‚  2ã€å¤„ç†ç»“æœã€‚

è¿™ä¸¤ä¸ªé˜¶æ®µä¸­é—´æœ‰`äº‹ä»¶å¾ªç¯`çš„è°ƒåº¦ï¼Œæ‰€ä»¥å½¼æ­¤ä¸å…³è”

```mermaid
graph LR;
    æäº¤è¯·æ±‚ --> äº‹ä»¶å¾ªç¯ --> å¤„ç†ç»“æœ
```
<div color=#f00 size=3 >**Nodeåœ¨å¤„ç†å¼‚å¸¸ä¸Šå½¢æˆäº†ä¸€ç§çº¦å®šï¼Œå°†å¼‚å¸¸ä½œä¸ºå›è°ƒå‡½æ•°ç¬¬ä¸€ä¸ªå®å‚ä¼ å›ï¼Œå¦‚æœä¸ºæ§åˆ¶ï¼Œåˆ™è¡¨æ˜å¼‚æ­¥è°ƒç”¨æ²¡æœ‰å¼‚å¸¸æŠ›å‡ºã€‚**</div>

JavaScriptçš„ tryâ€¦catch æœºåˆ¶ä¸èƒ½ç”¨æ¥æˆªè·å¼‚æ­¥æ–¹æ³•äº§ç”Ÿçš„é”™è¯¯ã€‚**æ–°æ‰‹çš„å¸¸è§é”™è¯¯ä¹‹ä¸€æ˜¯è¯•å›¾åœ¨é”™è¯¯ä¼˜å…ˆå›è°ƒå‡½æ•°ä¸­ä½¿ç”¨ throw**

å‚è€ƒï¼š[ã€Šé”™è¯¯ä¼˜å…ˆçš„å›è°ƒã€‹](http://nodejs.cn/api/errors.html#errors_error_first_callbacks)

é”™è¯¯ä¾‹å­ï¼š
```javascript
const fs = require('fs');

try {
  fs.readFile('/some/file/that/does-not-exist', (err, data) => {
    // é”™è¯¯çš„å‡è®¾ï¼šåœ¨è¿™é‡ŒæŠ›å‡ºé”™è¯¯ã€‚
    if (err) {
      throw err;
    }
  });
} catch (err) {
  // è¿™é‡Œä¸ä¼šæˆªè·å›è°ƒå‡½æ•°ä¸­çš„ throwã€‚
  console.error(err);
}
```

ä¼šå‡ºç°æŠ¥é”™ï¼š


![trycatchå¼‚æ­¥æŠ¥é”™.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/306b3162733746e8a8934b58f3d426ea~tplv-k3u1fbpfcp-watermark.image)

***
æ­£ç¡®ä¾‹å­ï¼š

``` javascript
function errorFirstCallback(err, data) {
    if (err) {
      console.error('å‡ºé”™', err);
      return;
    }
    console.log(data);
}
fs.readFile('./src/b.txt', errorFirstCallback)
```

<br><br>

***
## å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆ ğŸ³

å¼‚æ­¥ç¼–ç¨‹ä¸»è¦è§£å†³æ–¹æ¡ˆæœ‰ä¸‰ç§

* äº‹ä»¶å‘å¸ƒ/è®¢é˜…æ¨¡å¼
* Promise/Deferredæ¨¡å¼
* æµç¨‹æ§åˆ¶åº“


### äº‹ä»¶å‘å¸ƒ/è®¢é˜…æ¨¡å¼

äº‹ä»¶ç›‘å¬å™¨æ¨¡å¼æ˜¯ä¸€ç§å¹¿æ³›ç”¨äºå¼‚æ­¥ç¼–ç¨‹çš„æ¨¡å¼ï¼Œæ˜¯å›è°ƒå‡½æ•°çš„äº‹ä»¶åŒ–ï¼Œåˆç§°å‘å¸ƒ/è®¢é˜…æ¨¡å¼ã€‚

Nodeè‡ªèº«æä¾›çš„eventsäº‹ä»¶è§¦å‘å™¨æ¨¡å—æ˜¯å‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„ä¸€ä¸ªç®€å•å®ç°ã€‚

**æ‰€æœ‰è§¦å‘äº‹ä»¶çš„å¯¹è±¡éƒ½æ˜¯ `EventEmitter` ç±»çš„å®ä¾‹**ã€‚ è¿™äº›å¯¹è±¡æš´éœ²äº† `eventEmitter.on()` å‡½æ•°ï¼Œå…è®¸å°†ä¸€ä¸ªæˆ–å¤šä¸ªå‡½æ•°ç»‘å®šåˆ°å¯¹è±¡è§¦å‘çš„å‘½åäº‹ä»¶ã€‚ é€šå¸¸ï¼Œäº‹ä»¶åç§°æ˜¯é©¼å³°å¼å­—ç¬¦ä¸²ï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨ä»»ä½•æœ‰æ•ˆçš„ `JavaScript` å±æ€§é”®ã€‚

å½“ `EventEmitter` å¯¹è±¡è§¦å‘äº‹ä»¶æ—¶ï¼Œæ‰€æœ‰ç»‘å®šåˆ°è¯¥ç‰¹å®šäº‹ä»¶çš„å‡½æ•°éƒ½ä¼šè¢«åŒæ­¥åœ°è°ƒç”¨ã€‚ è¢«è°ƒç”¨çš„ç›‘å¬å™¨è¿”å›çš„ä»»ä½•å€¼éƒ½å°†è¢«å¿½ç•¥å’Œä¸¢å¼ƒã€‚

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†ä½¿ç”¨å•ä¸ªç›‘å¬å™¨çš„ç®€å•çš„ EventEmitter å®ä¾‹ã€‚ `eventEmitter.on()` æ–¹æ³•ç”¨äºæ³¨å†Œç›‘å¬å™¨ï¼Œ`eventEmitter.emit()` æ–¹æ³•ç”¨äºè§¦å‘äº‹ä»¶

### ç®€å•ä¾‹å­

``` javascript
const { EventEmitter, errorMonitor } = require('events');

class MyEmitter extends EventEmitter {}

const myEmitter = new MyEmitter();
// è®¢é˜…
myEmitter.on('event1', (val) => {
  console.log(val);
});
// å‘å¸ƒ
myEmitter.emit('event1', 'hello world!');
```

ç»“æœï¼šåœ¨è®¢é˜…ä¸­è¾“å‡º hello world!


è®¢é˜…å‡½æ•°å°±æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°çš„åº”ç”¨ï¼Œ äº‹ä»¶å‘å¸ƒ/è®¢é˜…æ¨¡å¼å¯ä»¥å®ç°ä¸€ä¸ªäº‹ä»¶ä¸å¤šä¸ªå›è°ƒå‡½æ•°çš„å…³è”ï¼Œè¿™äº›å›è°ƒå‡½æ•°åˆè¢«ç§°ä¸º<div color=#CE5CEA size=2 >**äº‹ä»¶ç›‘å¬å™¨**</div>

é€šè¿‡`emit()`å‘å¸ƒäº‹ä»¶åï¼Œæ¶ˆæ¯å›ç«‹å³ä¼ é€’ç»™å½“å‰äº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å™¨æ‰§è¡Œï¼Œç›‘å¬å™¨å¯ä»¥<div color=#65CE23  >æ·»åŠ å’Œåˆ é™¤</div>ã€‚

åœ¨Nodeä¸­ï¼Œ `emit()`è°ƒç”¨å¤šåŠæ˜¯ä¼´éšäº‹ä»¶å¾ªç¯è€Œå¼‚æ­¥è§¦å‘çš„ã€‚

### ç›‘å¬å™¨è¿‡å¤šè­¦å‘Š

> æ³¨æ„ï¼š
> å¦‚æœä¸€ä¸ªäº‹ä»¶æ·»åŠ äº†è¶…è¿‡10ä¸ªç›‘å¬å™¨ï¼Œå°†ä¼šå¾—åˆ°ä¸€æ¡è­¦å‘Šã€‚ å¹¶ä¸”äº‹ä»¶ç›¸å…³çš„ç›‘å¬å™¨è¿‡å¤šï¼Œå¯èƒ½å­˜åœ¨è¿‡å¤šå ç”¨CPUçš„æƒ…æ™¯ã€‚
> 
``` javascript
for (let i = 0; i < 11; i++) {
    myEmitter.on('event1', (val) => {
        console.log(i);
    });
}
// å‘å¸ƒ
myEmitter.emit('event1', 'hello world!');
```
 
![ç›‘å¬å™¨è¿‡å¤šè­¦å‘Š.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8d8b85e393243d09ae317ad3cf9cfc2~tplv-k3u1fbpfcp-watermark.image)

å¦‚æœæƒ³è¦<div color=#CE9123 >**å»é™¤è­¦å‘Š**</div>ï¼Œè°ƒç”¨`setMaxListeners(0);`å¯ä»¥å»é™¤é™åˆ¶

`myEmitter.setMaxListeners(0);` æ·»åŠ åœ¨forå¾ªç¯å‰å³å¯
